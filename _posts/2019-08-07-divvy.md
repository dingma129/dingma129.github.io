---
title: Chicago Divvy Bicycle
author: Ding Ma
layout: post
categories: [blog,project]
---

<span style="font-weight:bold;font-size:48px">Chicago Divvy Bicycle Project</span>

[<span style="color:blue">Divvy</span>](https://www.divvybikes.com/) is a bicycle sharing system in the City of Chicago and two adjacent suburbs operated by Motivate for the Chicago Department of Transportation. It operates 5800 bicycles at 580 stations in an area bounded by 87th Street on the south, Central Street in Evanston on the north, Rainbow Beach Park near South Shore Drive on the east, and Harlem Avenue in Oak Park on the west.

In this blog, I proformed a series of data processing, visualization, and analysis.

------

<span style="font-weight:bold;font-size:36px">1. Data Description</span>

In this project, we will use the Divvy Bicycle data from 2013 to 2018. There are two data sets, which can be downloaded from the links.

1. [<span style="color:blue">data set of historical trip</span>](https://www.divvybikes.com/system-data), which includes:
   * trip start day and time
   * trip end day and time
   * trip start station id
   * trip end station id
   * rider type (Member, Single Ride, and Explore Pass)
   * ...
2. [<span style="color:blue">data set of stations</span>](https://data.cityofchicago.org/Transportation/Divvy-Bicycle-Stations-Historical/eq45-8inv), which includes:
   * station id
   * timestamp: recorded every 10 minutes
   * docks in service
   * percent full: percentage of docks in service containing an available bike
   * latitude
   * longitude
   * ...

------

<span style="font-weight:bold;font-size:36px">2. Exploratory Data Visualization</span>

<span style="font-weight:bold;font-size:24px">Stations at the end of 2017</span>

Here is an [<span style="color:blue">interactive map</span>](https://dingma129.github.io/assets/active_image/divvy/station_distribution.html) for station distribution. We can see that most of the stations are located in the downtown area.

<span style="font-weight:bold;font-size:24px">By Year</span>

Annual total trip counts were growing from 2014 to 2017. However, the average trip duration did not change at all.

<img src="https://dingma129.github.io/assets/figures/divvy/tripcountvsyear.png" width="800">

<span style="font-weight:bold;font-size:24px">By Month</span>

During June, July, August and September, there were more trips. The average trip duration was also relatively longer during those four months. 

<img src="https://dingma129.github.io/assets/figures/divvy/tripcountvsmonth.png" width="800">

<span style="font-weight:bold;font-size:24px">By Day of Week</span>

There were more rides during weekdays comparing to weekends. But the average trip duration was longer during weekend. 

<img src="https://dingma129.github.io/assets/figures/divvy/tripcountvsdayofweek.png" width="800">

<span style="font-weight:bold;font-size:24px">By Hour</span>

If we take a closer look, there are particular patterns within a day.

- During weekday, there were two peaks of trip counts. One happened at 7:00-8:59, and the other happened at 16:00-18:59.
- During weekend, there was plenty of rides during 8:00-20:59 with no sharp peak.

<img src="https://dingma129.github.io/assets/figures/divvy/tripcountvshour.png" width="800">

------

<span style="font-weight:bold;font-size:36px">3. Goal of This Project</span>

From the last figure above, we can see that in the weekday, there are much more trip happened during 7:00-8:59 and 16:00-18:59 comparing to other time. So a natural question is: <u>Does every station behave differently</u>?

<span style="font-weight:bold;font-size:24px">Goal:</span>

1. group stations according to their behaviors during weekday, and analyze the reasons causing those different behaviours
2. for each station, create a time-series model to predict the future station usage based on historical data
3. given a GPS location, suggest a user to a nearby station with highest probability that may have an available bike to borrow or may have an available dock to return a borrowed bike

------

<span style="font-weight:bold;font-size:36px">4. Data Analyses</span>
<span style="font-weight:bold;font-size:24px">4.1 group stations by their weekday behaviors</span>

For simplicity, we only consider the data after 2016. (since after 2016, the stations do not change a lot)

1. take hourly average over `percent full` column for each station, and create a pivot table like the following.

   <img src="https://dingma129.github.io/assets/figures/divvy/dataset_1.png" width="900">

2. keep the records on business day only

3. take the average on each of the 24-hour over all business days, and get a data frame with rows being all station ids and columns being 24 hours

   <img src="https://dingma129.github.io/assets/figures/divvy/dataset_pivot.png" width="900">

4. run k mean models and gaussian mixture models with 2-9 clusters over this data set, and select the best model using silhouette score

   <img src="https://dingma129.github.io/assets/figures/divvy/model_selection.png" width="600">

   so the best model is k means with 3 clusters

5. if we plot the average `percent full` for each stations with different colors corresponding to their group assigned by k means, and also the group mean, we can clearly see the difference between those 3 groups

   <img src="https://dingma129.github.io/assets/figures/divvy/3_groups.png" width="900">

6. <span style="color:red">a brief conclusion:</span>

   From the above graph, we can see that four groups behave differently:

   * <span style="font-weight:bold">Group 0</span>: <span style="font-weight:bold">high</span> full percentage during moring and night, <span style="font-weight:bold">normal</span> full percentage during daytime

   * <span style="font-weight:bold">Group 1</span>: has a <span style="font-weight:bold">normal</span> 24 hour full percentage, <span style="font-weight:bold">stable</span> during whole day

   * <span style="font-weight:bold">Group 2</span>: <span style="font-weight:bold">low</span> full percentage during moring and night, <span style="font-weight:bold">high</span> full percentage during daytim7

7. in order to see the reason that causing such different behaviors, we plot all the stations with their labels on a map (click [<span style="color:blue">here</span>](https://dingma129.github.io/assets/active_image/divvy/3_groups_large.html) for a large version)

   <embed src="https://dingma129.github.io/assets/active_image/divvy/3_groups_small.html" width="460" height="620">

8. <span style="color:red">Further explanations</span>
   The graph above explains the `percent full` behaviours of each group

   * <span style="font-weight:bold">Group 0</span>: <span style="font-weight:bold">high</span> full percentage during moring and night, <span style="font-weight:bold">normal</span> full percentage during daytime

     <span style="font-weight:bold">Reason:</span> They mainly locate at living areas. In the morning, there are lots of bicycles. Then people ride them to work, which results in a dramatic decrease of Full Percentage around 6:00-8:00. During daytime, there are few number of bicycles until people ride bicycles from work to home around 16:00-18:00.

   * <span style="font-weight:bold">Group 1</span>: has a <span style="font-weight:bold">normal</span> 24 hour full percentage, <span style="font-weight:bold">stable</span> during whole day

     <span style="font-weight:bold">Reason:</span> Not many people use those stations, so the full percentage rarely changes. 

   * <span style="font-weight:bold">Group 2</span>: <span style="font-weight:bold">low</span> full percentage during moring and night, <span style="font-weight:bold">high</span> full percentage during daytime

     <span style="font-weight:bold">Reason:</span> They mainly locate at working areas (downtown Chicago). In the morning, there are few bicycles. Then people ride bicycles from home to work, which results in a dramatic increase of Full Percentage around 6:00-8:00. During daytime, there are lots of bicycles until people ride bicycles back to home around 16:00-18:00.

   


9. <span style="font-weight:bold">Remark: Similar analysis can be done for weekend information, and we will skip it here.</span>



<span style="font-weight:bold;font-size:24px">4.2 predict the future station usage using time-series model</span>

We will use [<span style="color:blue">Holt-Winters model(triple exponential smoothing model)</span>](https://en.wikipedia.org/wiki/Exponential_smoothing) to make the prediction.

<span style="font-weight:bold">Why do we choose such a model?</span>
The reason why we use triple exponential smoothing instead of single or double is that the station usage has an obvious seasonal change and also a slightly increasing trend. 


This model is not implemented in Python, we write our own model class. There are 3 main parameters for this model.

* 0<<span style="font-weight:bold">α</span><1: data smoothing factor
* 0<<span style="font-weight:bold">β</span><1: trend smoothing factor
* 0<<span style="font-weight:bold">γ</span><1: seasonal change smoothing factor

we first build a separate model for every single station, using random cross-validation to choose the values of <span style="font-weight:bold">α,β,γ</span>. The model will use the `percent full` data in the past 28 days to make predictions in the next 7 days.

Here is one example for station #37, click [<span style="color:blue">here</span>](https://dingma129.github.io/assets/figures/divvy/station_37.png) for a large image.

<img src="https://dingma129.github.io/assets/figures/divvy/station_37.png" width="800">

The above figure shows the prediction of `percent full` of station #37 in the next 7 days, along with a 90% confidence interval.



<span style="font-weight:bold;font-size:24px">4.3 suggesting stations to borrow or return a bicycle</span>

the last part of this project is to create a user interface that allows user to provide

* a GPS location
* a future time spot
* specify whether he/she wants to borrow or return a bicycle

it will output a map of nearest stations with highest probability where the user can borrow or return a bicycle

for example, with

```python
test_lat = 41.882 
test_lon = -87.63
future_time = '2018-09-21 14:00:00'
finding_bikes = True
```

the model will output the following text and figure

```
At 2018-09-21 14:00:00 

station 49 is predicted to be 78.39% full
station 81 is predicted to be 59.13% full
station 37 is predicted to be 64.15% full
```

<embed src="https://dingma129.github.io/assets/active_image/divvy/finding_bikes_small.html" width="460" height="620">